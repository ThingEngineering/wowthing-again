<script lang="ts">
    import { InventorySlot } from '@/enums'
    import { settingsStore, userStore } from '@/stores'
    import type { BackgroundImage, Character } from '@/types'

    import Configure from './CharactersPaperdollConfigure.svelte'
    import Equipped from './CharactersPaperdollEquipped.svelte'

    export let character: Character

    let selected = character.configuration.backgroundId

    let backgroundImage: BackgroundImage
    let characterImage: string
    let filter: string
    $: {
        backgroundImage = $userStore.backgrounds[selected === -1 ? $settingsStore.characters.defaultBackgroundId : selected]
        characterImage = $userStore.images[`${character.id}-2`]

        if (backgroundImage) {
            const filterParts: string[] = []

            const brightness = character.configuration.backgroundBrightness !== -1
                ? character.configuration.backgroundBrightness
                : backgroundImage.defaultBrightness
            const saturation = character.configuration.backgroundSaturation !== -1
                ? character.configuration.backgroundSaturation
                : backgroundImage.defaultSaturate

            if (brightness != 10) {
                filterParts.push(`brightness(${brightness / 10})`)
            }
            if (saturation != 10) {
                filterParts.push(`saturate(${saturation / 10})`)
            }
            filter = filterParts.join(' ')
        }
    }

    const leftSide: InventorySlot[] = [
        InventorySlot.Head,
        InventorySlot.Neck,
        InventorySlot.Shoulders,
        InventorySlot.Back,
        InventorySlot.Chest,
        InventorySlot.Shirt,
        InventorySlot.Tabard,
        InventorySlot.Wrist,
    ]
    const rightSide: InventorySlot[] = [
        InventorySlot.Hands,
        InventorySlot.Waist,
        InventorySlot.Legs,
        InventorySlot.Feet,
        InventorySlot.Ring1,
        InventorySlot.Ring2,
        InventorySlot.Trinket1,
        InventorySlot.Trinket2,
    ]
</script>

<style lang="scss">
    .paperdoll {
        --scale: 0.9;

        background-color: $highlight-background;
        border-bottom-left-radius: $border-radius;
        border-bottom-right-radius: $border-radius;
        height: 750px;
        margin: -1rem;
        position: relative;
        width: calc(100% + 2rem);

        &::before {
            background-image: var(--background-image);
            background-position: 50% 50%;
            background-size: cover;
            border-bottom-left-radius: $border-radius;
            border-bottom-right-radius: $border-radius;
            content: "";
            filter: var(--background-filter, unset);
            height: 100%;
            left: 0;
            position: absolute;
            top: 0;
            width: 100%;
        }

        &.race-6,  // Tauren
        &.race-28, // Highmountain Tauren
        &.race-32  // Kul Tiran
        {
            --scale: 0.75;
        }

        &.race-2,  // Orc
        &.race-36, // Mag'har Orc
        &.race-8,  // Troll
        &.race-31, // Zandalari Troll
        &.race-52  // Dracthyr
        {
            --scale: 0.75;
        }

        &.race-10  // Blood Elf
        {
            --scale: 0.95;
        }

        &.race-4,  // Night Elf
        &.race-11, // Draenei
        &.race-27, // Nightborne
        &.race-30  // Lightforged Draenei
        {
            --scale: 0.8;
        }
    }
    .paperdoll-configurable {
        border-bottom: 1px solid $border-color;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        margin-bottom: 0;

        .attribution {
            border-bottom-right-radius: 0;
        }
    }
    .character-image {
        bottom: 110px;
        filter:
            drop-shadow(-2px -2px 2px rgba(0, 0, 0, 0.5))
            drop-shadow(-2px  2px 2px rgba(0, 0, 0, 0.5))
            drop-shadow( 2px -2px 2px rgba(0, 0, 0, 0.5))
            drop-shadow( 2px  2px 2px rgba(0, 0, 0, 0.5))
            saturate(1.2)
            brightness(1.2)
        ;
        left: 50%;
        position: absolute;
        transform: translateX(-50%) scale(var(--scale, 1.0));
        transform-origin: bottom;
    }
    .equipped {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 0.8rem;

        &.left {
            left: 1.5rem;
        }
        &.right {
            right: 1.5rem;
        }
    }
    .weapon {
        bottom: 2rem;
        position: absolute;

        &.left {
            right: calc(50% + 0.5rem);
        }
        &.right {
            left: calc(50% + 0.5rem);
        }
    }
    .attribution {
        position: absolute;
        bottom: -1px;
        right: -1px;
        background: $thing-background;
        border-bottom-left-radius: 0;
        border-top-right-radius: 0;
        padding: 0 0.4rem 0.2rem 0.4rem;
    }
</style>

<div
    class="paperdoll race-{character.raceId}"
    class:paperdoll-configurable={!$userStore.public}
    style:--background-image={backgroundImage ? `url(https://img.wowthing.org/backgrounds/${backgroundImage.filename})` : undefined}
    style:--background-filter={filter}
>
    {#if characterImage}
        <img
            alt="Character image for {character.name}"
            class="character-image drop-shadow"
            src="{characterImage}"
        >
    {/if}

    <div class="equipped left">
        {#each leftSide as inventorySlot}
            <Equipped
                {character}
                {inventorySlot}
            />
        {/each}
    </div>

    <div class="equipped right">
        {#each rightSide as inventorySlot}
            <Equipped
                {character}
                {inventorySlot}
                leftSide={true}
            />
        {/each}
    </div>

    <div class="weapon left">
        <Equipped
            inventorySlot={InventorySlot.MainHand}
            {character}
            leftSide={true}
        />
    </div>

    <div class="weapon right">
        <Equipped
            inventorySlot={InventorySlot.OffHand}
            {character}
        />
    </div>

    {#if backgroundImage}
        <div class="attribution border">
            {@html backgroundImage.attribution}
        </div>
    {/if}
</div>

{#if !$userStore.public}
    <Configure
        bind:backgroundBrightness={character.configuration.backgroundBrightness}
        bind:backgroundSaturation={character.configuration.backgroundSaturation}
        bind:selected
        {character}
    />
{/if}
