<script lang="ts">
    import {
        emberCourtFeatures,
        emberCourtFriends,
        emberCourtUpgrades,
        emberCourtUpgrades2,
        type EmberCourtFeature,
        type EmberCourtFeatureType
    } from '@/data/covenant'
    import { userQuestStore } from '@/stores'
    import { staticStore } from '@/shared/stores/static'
    import findReputationTier from '@/utils/find-reputation-tier'
    import { basicTooltip,  componentTooltip } from '@/shared/utils/tooltips'
    import type { Character, ReputationTier } from '@/types'

    export let character: Character

    import ReputationText from '@/components/common/ReputationText.svelte'
    import Tooltip from '@/components/tooltips/reputation/TooltipReputation.svelte'
    import WowthingImage from '@/shared/components/images/sources/WowthingImage.svelte'

    let quests: Set<number>
    let tier: ReputationTier
    $: {
        tier = findReputationTier(
            $staticStore.reputationTiers[$staticStore.reputations[2445].tierId],
            character.reputations?.[2445] ?? 0
        )

        quests = $userQuestStore.characters[character.id]?.quests
    }

    const thingSets: [EmberCourtFeature[], number][] = [
        [emberCourtFeatures, 40],
        [emberCourtUpgrades, 32],
        [emberCourtUpgrades2, 48],
    ]

    const getTooltip = function(type: EmberCourtFeatureType): string {
        let ret = type.name
        if (type.unlockReputation > 0) {
            const tierName = $staticStore.reputationTiers[0].names[8 - type.unlockReputation]
            ret += `<br><br>Requires <span class="reputation${type.unlockReputation}">${tierName}</span> reputation`
        }
        return ret
    }
</script>

<style lang="scss">
    .court {
        display: flex;
        margin-top: 0.75rem;
        overflow: hidden;
    }
    .guests {
        flex-direction: column;
    }
    .features {
        flex-wrap: wrap;
    }
    .slot {
        display: flex;

        &:not(:last-child) {
            border-bottom: 1px solid #aaa;
        }
    }
    .friend {
        position: relative;
        width: 25%;

        &:not(:last-child) {
            border-right: 1px solid $border-color;
        }
    }
    .name {
        background: #3f1018;
        border-bottom: 1px solid $border-color;
        font-size: 0.9rem;
        padding: 0.2rem 0.2rem;
        text-align: center;
    }
    .unlocked {
        background: #103f10;
    }
    .reputation {
        padding: 0.2rem 0;

        :global(.progress-container) {
            border-width: 0;
            margin: 0;
        }
    }
    .bff {
        //background: mix($thing-background, $color-success, 90%);
        color: lighten($color-success, 20%);
    }
    .feature {
        --image-border-width: 2px;
        display: flex;
        gap: 0.4rem;
        justify-content: center;
        padding: 0.3rem;
        width: 50%;

        &:nth-child(odd) {
            border-right: 1px solid $border-color;
        }
        &:nth-child(n+3) {
            border-top: 1px solid $border-color;
        }
        &:only-child {
            border-right-width: 0;
            width: 100%;
        }
    }
    .type {
        &.locked {
            filter: grayscale(100%);
        }
        &.available {
            --image-border-color: #{$color-fail};
        }
        &.unlocked {
            --image-border-color: #{$color-success};
        }
    }
</style>

<div class="court guests border">
    {#each emberCourtFriends as slot}
        <div class="slot">
            {#each slot as friend}
                {@const bff = quests?.has(friend.friendQuestId)}
                {@const rsvp = quests?.has(friend.rsvpQuestId)}
                <div
                    class="friend"
                    use:componentTooltip={{
                        component: Tooltip,
                        props: {
                            bottom: bff ? `<span class="status-success">Friend of a Friend!</span>` : undefined,
                            character,
                            characterRep: character.reputations?.[friend.reputationId] ?? 0,
                            dataRep: $staticStore.reputations[friend.reputationId],
                        },
                    }}
                >
                    <div
                        class="name text-overflow"
                        class:bff
                        class:unlocked={rsvp}
                    >
                        {friend.name}
                    </div>
                    
                    <div class="reputation">
                        <ReputationText
                            reputationId={friend.reputationId}
                            {character}
                        />
                    </div>
                </div>
            {/each}
        </div>
    {/each}
</div>

{#each thingSets as [things, iconSize]}
    <div class="court features border">
        {#each things as thing}
            {@const featureUnlocked = quests?.has(thing.unlockQuestId)}
            <div
                class="feature"
                class:unlocked={featureUnlocked}
            >
                {#each thing.types as type}
                    {@const typeUnlocked = quests?.has(type.unlockQuestId)}
                    {@const typeReputation = type.unlockReputation || thing.unlockReputation || 0}
                    <div
                        class="type"
                        class:locked={!typeUnlocked && tier?.tier > typeReputation}
                        class:available={!typeUnlocked && tier?.tier <= typeReputation}
                        class:unlocked={typeUnlocked}
                        use:basicTooltip={{
                            allowHTML: true,
                            content: getTooltip(type),
                        }}
                    >
                        <WowthingImage
                            name={type.icon}
                            size={iconSize}
                            border={2}
                        />
                    </div>
                {/each}
            </div>
        {/each}
    </div>
{/each}
